{% extends 'base.html' %}
{% load static %}

{% block titulo %}{{ produto.nome }} - Comparar Preços - {{ block.super }}{% endblock %}

{% block css_local %}
<link href="{% static 'css/produto_form.css' %}" rel="stylesheet">
<style>
    .produto-detail-img { 
        width: 100%; 
        max-height: 420px; 
        object-fit: cover; 
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 160, 160, 0.15);
    }

    .produto-header {
        background: linear-gradient(135deg, rgba(0, 160, 160, 0.05) 0%, rgba(0, 255, 179, 0.05) 100%);
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        border: 1px solid rgba(0, 160, 160, 0.1);
    }

    .produto-header h1 {
        font-size: 2.2rem;
        font-weight: 800;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .produto-header .loja-info {
        font-size: 1rem;
        color: #666;
        margin-bottom: 1rem;
    }

    .produto-header .preco-principal {
        font-size: 2rem;
        font-weight: 800;
        color: var(--accent-color);
        margin-bottom: 1rem;
    }

    .produto-header .rating-section {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .produto-header .rating-section .stars {
        font-size: 1.3rem;
    }

    .produto-header .rating-section .valor {
        font-weight: 700;
        color: var(--primary-color);
    }

    .btn-curtir-produto {
        background-color: transparent !important;
        border: none !important;
        box-shadow: none !important;
        padding: 0;
        color: var(--bs-danger);
        font-size: 1.8rem;
        line-height: 1;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .btn-curtir-produto:hover, .btn-curtir-produto.curtido {
        transform: scale(1.1);
    }
    .btn-curtir-produto:focus, .btn-curtir-produto:active {
        outline: none !important;
        box-shadow: none !important;
        background-color: transparent !important;
    }

    .curtidas-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 1rem;
    }

    .descricao-section {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 12px rgba(0, 160, 160, 0.08);
    }

    .descricao-section h3 {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 1rem;
    }

    .descricao-section p {
        line-height: 1.8;
        color: #333;
    }

    .ofertas-section {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 160, 160, 0.08);
    }

    .ofertas-section h3 {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 1.5rem;
    }

    .list-group-item.active {
        z-index: 2;
        color: var(--bs-white);
        background-color: var(--primary-color);
        border-color: var(--accent-color);
    }

    .list-group-item.active .loja-nome,
    .list-group-item.active .text-muted {
        color: var(--bs-white) !important;
        opacity: 0.9;
    }

    .oferta-item .loja-nome {
        font-weight: 700;
        color: var(--primary-color);
        font-size: 1.05rem;
    }

    .oferta-item .preco-oferta {
        font-size: 1.3rem;
        font-weight: 700;
        color: #239465 !important;
    }

    .avaliacoes-section {
        background: linear-gradient(135deg, rgba(0, 160, 160, 0.05) 0%, rgba(0, 255, 179, 0.05) 100%);
        padding: 2rem;
        border-radius: 12px;
        border: 1px solid rgba(0, 160, 160, 0.1);
        margin-top: 2rem;
    }

    .avaliacoes-section h3 {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 1.5rem;
    }

    .formulario-avaliacao {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
    }

    .avaliacao-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        border-left: 4px solid var(--accent-color);
        box-shadow: 0 2px 8px rgba(0, 160, 160, 0.08);
    }

    .avaliacao-card .usuario {
        font-weight: 700;
        color: var(--primary-color);
    }

    .avaliacao-card .data {
        font-size: 0.85rem;
        color: #999;
    }

    @media (max-width: 768px) {
        .produto-header h1 {
            font-size: 1.8rem;
        }

        .produto-header .preco-principal {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block carrossel %}
{% endblock%}

{% block conteudo %}
<div class="container mt-4">
    <div class="row g-4">
        <!-- Coluna da Esquerda: Produto e Descrição -->
        <div class="col-lg-7">
            <!-- Card do Produto Principal -->
            <div class="produto-header">
                <div class="row g-4 align-items-center">
                    <div class="col-md-6">
                        {% if produto.foto %}
                            <img src="{{ MEDIA_URL }}{{ produto.foto }}" class="produto-detail-img" alt="{{ produto.nome }}">
                        {% else %}
                            <div class="d-flex align-items-center justify-content-center" style="height: 100%; min-height: 300px; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); border-radius: 12px;">
                                <i class="bi bi-bag" style="font-size: 6rem; color: rgba(255, 255, 255, 0.5);"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <h1><i class="bi bi-bag-check"></i> {{ produto.nome }}</h1>
                        <p class="loja-info">
                            <i class="bi bi-shop"></i>
                            Vendido por: <a href="{% url 'loja:loja_detail' produto.loja.pk %}" class="text-decoration-none">{{ produto.loja.nome }}</a>
                        </p>
                        
                        <div class="preco-principal">R$ {{ produto.preco|floatformat:2 }}</div>

                        <div class="rating-section">
                            <div class="stars">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= produto.avaliacao_media %}
                                        <i class="bi bi-star-fill text-warning"></i>
                                    {% elif forloop.counter|add:"-1" < produto.avaliacao_media %}
                                        <i class="bi bi-star-half text-warning"></i>
                                    {% else %}
                                        <i class="bi bi-star text-warning"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="valor">{{ produto.avaliacao_media|floatformat:1 }}/5</span>
                        </div>

                        {% if user.is_authenticated %}
                        <div class="curtidas-info">
                            <button type="button" class="btn-curtir-produto {% if curtido %}curtido{% endif %}"
                                    data-url="{% url 'produto:curtir' produto.id %}" 
                                    data-csrf="{{ csrf_token }}"
                                    data-count-target="curtidas-count-{{ produto.id }}"
                                    title="Curtir produto">
                                <i class="bi {% if curtido %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
                            </button>
                            <span id="curtidas-count-{{ produto.id }}">{{ produto.curtido_por.count }}</span> curtida{{ produto.curtido_por.count|pluralize }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Descrição -->
            <div class="descricao-section mt-4">
                <h3><i class="bi bi-info-circle"></i> Descrição</h3>
                <p>{{ produto.descricao|default:"Este produto não possui uma descrição detalhada." }}</p>
                
                {% if user.is_superuser or user.email == produto.loja.email %}
                <a href="{% url 'produto:produto_update' produto.pk %}" class="btn btn-secondary mt-3">
                    <i class="bi bi-pencil-square"></i> Editar Produto
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Coluna da Direita: Comparador e Avaliações -->
        <div class="col-lg-5">
            <!-- Comparador de Preços -->
            <div class="ofertas-section">
                <h3><i class="bi bi-tag"></i> Disponível em {{ ofertas.count }} loja(s)</h3>
                
                <div class="list-group">
                    {% for oferta in ofertas %}
                    <a href="{% url 'produto:produto_detail' pk=oferta.pk %}" class="list-group-item list-group-item-action {% if oferta.pk == produto.pk %}active{% endif %}">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1 loja-nome">{{ oferta.loja.nome }}</h5>
                            <strong class="preco-oferta">R$ {{ oferta.preco|floatformat:2 }}</strong>
                        </div>
                        <p class="mb-1 small text-muted"><i class="bi bi-geo-alt"></i> {{ oferta.loja.endereco }}</p>
                    </a>
                    {% endfor %}
                </div>
            </div>

            <!-- Seção de Avaliações -->
            <div class="avaliacoes-section mt-4">
                <h3><i class="bi bi-star"></i> Avaliações do Produto</h3>

                <!-- Formulário de Avaliação -->
                {% if user.is_authenticated %}
                    {% if ja_avaliou %}
                        <div class="alerta-ja-avaliou">
                            <strong><i class="bi bi-check-circle"></i> Obrigado!</strong> Você já avaliou este produto. Sua avaliação foi registrada com sucesso.
                        </div>
                    {% else %}
                        <div class="formulario-avaliacao">
                            <h4><i class="bi bi-pencil-square"></i> Deixe sua Avaliação</h4>
                            <form method="post" action="{% url 'produto:avaliar' produto.id %}" id="form-avaliacao-produto">
                                {% csrf_token %}

                                <!-- Estrelas -->
                                <div class="mb-3">
                                    <label class="form-label"><strong>Sua Nota</strong></label>
                                    <div class="rating mb-2" style="justify-content: center;">
                                        {% for i in "12345" %} {# Ordem correta para o JS funcionar da esquerda para a direita #}
                                            <input type="radio" id="star-produto-{{ i }}" name="nota" value="{% widthratio forloop.counter 1 -1 as neg_counter %}{{ 6|add:neg_counter }}" class="d-none">
                                            <label for="star-produto-{{ i }}" class="star-label" style="cursor:pointer; font-size:2.5rem; order: {{ i }};">
                                                <i class="bi bi-star-fill"></i>
                                            </label>
                                        {% endfor %}
                                    </div>
                                </div>
                                <!-- Caixa de comentário -->
                                <div class="mb-3">
                                    <label for="comentario" class="form-label"><strong>Comentário (Opcional)</strong></label>
                                    <textarea name="comentario" id="comentario" class="form-control" placeholder="Compartilhe sua experiência com este produto..." rows="3"></textarea>
                                </div>

                                <button type="submit" class="btn btn-custom-primary w-100">
                                    <i class="bi bi-send"></i> Enviar Avaliação
                                </button>
                            </form>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning text-center">
                        <i class="bi bi-exclamation-triangle"></i> 
                        Faça <a href="{% url 'login' %}" class="alert-link"><strong>login</strong></a> para avaliar este produto.
                    </div>
                {% endif %}

                <!-- Lista de Avaliações -->
                <div class="mt-4">
                    <h4 style="font-size: 1.3rem; font-weight: 700; color: var(--primary-color); margin-bottom: 1.5rem;">
                        <i class="bi bi-chat-dots"></i> Avaliações de Clientes
                    </h4>
                    
                    {% for avaliacao in avaliacoes %}
                    <div class="avaliacao-card">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="usuario">@{{ avaliacao.usuario.username }}</span>
                                <div class="stars" style="color: gold; font-size: 0.9rem;">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= avaliacao.nota %}
                                            <i class="bi bi-star-fill"></i>
                                        {% else %}
                                            <i class="bi bi-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <span class="data">{{ avaliacao.criado_em|date:"d/m/Y H:i" }}</span>
                        </div>
                        {% if avaliacao.comentario %}
                            <p class="comentario">{{ avaliacao.comentario }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript_local %}
<script src="{% static 'js/avaliacao.js' %}"></script>
{% endblock %}
