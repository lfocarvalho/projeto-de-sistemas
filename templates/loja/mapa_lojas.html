{% extends 'base.html' %}
{% load static %}

{% block titulo %}Localizar Lojas - {{ block.super }}{% endblock %}

{% block css_local %}
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #mapid {
            height: 600px; /* Altura do mapa */
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .map-container {
            padding: 20px;
            background-color: var(--bg-secondary);
            border-radius: 12px;
        }
        /* Estilo para o botão de localização */
        .leaflet-control-custom button {
            /* Bootstrap button classes will handle background, border, border-radius, hover/active states */
            /* We enforce specific dimensions and centering for a square icon button */
            width: 36px; /* Tamanho do botão */
            height: 36px;
            line-height: 36px; /* Centraliza o ícone verticalmente */
            text-align: center;
            cursor: pointer;
            font-size: 1.3em; /* Tamanho do ícone */
            padding: 0; /* Remove padding padrão do botão */
            display: flex; /* Usa flexbox para centralização precisa */
            align-items: center;
            justify-content: center;
            margin: 2px; /* Pequena margem para separar de outros controles */
            /* Cores e bordas serão definidas pelas classes Bootstrap como btn-light */
        }
        /* Estilo para as mensagens no mapa */
        .leaflet-control-container .info.alert {
            margin: 10px; /* Espaçamento das bordas do mapa */
        }
    </style>
{% endblock %}

{% block conteudo %}
<div class="container mt-4">
    <div class="map-container">
        <h2 class="mb-4 text-center"><i class="bi bi-geo-alt-fill"></i> Nossas Lojas no Mapa</h2>
        <div id="mapid"></div>
    </div>
</div>
{% endblock %}

{% block javascript_local %}
    <!-- Leaflet JS -->
    {{ loja_para_editar|json_script:"loja-para-editar-data" }}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mapContainer = document.getElementById('mapid');
            // Só inicializa o mapa se o elemento existir
            if (!mapContainer) {
                console.error("Elemento do mapa #mapid não encontrado.");
                return;
            }
            
            // Definir constantes para os níveis de zoom e padding
            const DEFAULT_ZOOM = 4; // Zoom para o Brasil (ou área ampla)
            const USER_LOCATION_ZOOM = 13; // Zoom para a localização do usuário
            const SINGLE_STORE_ZOOM = 15; // Zoom para uma única loja
            const FIT_BOUNDS_PADDING = [50, 50]; // Preenchimento para fitBounds ao ajustar limites

            // Inicializa o mapa
            // Coordenadas de exemplo (Brasília como centro, ou outra coordenada inicial)
            var mymap = L.map('mapid').setView([-15.7801, -47.9292], DEFAULT_ZOOM);
            var userMarker;

            // Verifica se estamos no modo de edição
            let lojaParaEditar = null;
            const lojaParaEditarDataElem = document.getElementById('loja-para-editar-data');
            if (lojaParaEditarDataElem) {
                const content = lojaParaEditarDataElem.textContent;
                if (content && content.trim() !== 'null') {
                    lojaParaEditar = JSON.parse(content);
                }
            }
            const isEditMode = lojaParaEditar !== null;

            // Variáveis globais para os marcadores das lojas e mensagens de controle
            var storeMarkers = L.layerGroup().addTo(mymap); // Grupo para os marcadores das lojas

            // Controle global de mensagens
            var mapMessageControl = L.control({ position: 'topright' });
            mapMessageControl.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'info alert');
                this._div.style.display = 'none';
                return this._div;
            };
            mapMessageControl.addTo(mymap);

            function displayMapMessage(message, type = 'info') {
                mapMessageControl._div.className = `info alert alert-${type}`;
                mapMessageControl._div.innerHTML = message;
                mapMessageControl._div.style.display = 'block';
            }

            function clearMapMessage() {
                mapMessageControl._div.style.display = 'none';
                mapMessageControl._div.innerHTML = '';
            }

            // --- Definição dos Ícones Coloridos ---
            var blueIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            var redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            var userIcon = new L.Icon({ // Ícone para a localização do usuário
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            // Adiciona a camada de tiles (o mapa de fundo) do OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mymap);

            // Função para salvar a localização da loja (modo de edição)
            function salvarLocalizacao(lat, lon) {
                if (!isEditMode) return;
                displayMapMessage('Salvando...', 'info'); // Feedback para o usuário

                // Gera a URL dinamicamente para evitar erros de rota
                const urlTemplate = "{% url 'loja:api-salvar-localizacao' 0 %}";
                const url = urlTemplate.replace('0', lojaParaEditar.id);
                const csrfToken = '{{ csrf_token }}'; // Corrigido para usar a tag de template

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ lat: lat, lon: lon })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayMapMessage(`Localização da loja <strong>${lojaParaEditar.nome}</strong> atualizada com sucesso! <a href="{% url 'loja:loja_detail' 0 %}".replace('0', lojaParaEditar.id) class="alert-link">Ver detalhes</a>.`, 'success');
                    } else {
                        const errorMsg = data.message || 'Falha ao salvar a localização.';
                        displayMapMessage(errorMsg, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Erro ao salvar localização:', error);
                    displayMapMessage('Erro ao salvar a localização.', 'danger');
                });
            }

            // Botão de Salvar Personalizado (para modo de edição)
            var SaveButton = L.Control.extend({
                options: { position: 'topright' },
                onAdd: function (map) {
                    var container = L.DomUtil.create('div', 'leaflet-control leaflet-control-custom');
                    container.innerHTML = '<button id="save-location-btn" type="button" class="btn btn-success" title="Salvar nova localização"><i class="bi bi-check-circle-fill"></i> Salvar</button>';
                    L.DomEvent.disableClickPropagation(container);
                    // O evento de clique será adicionado dinamicamente
                    return container;
                },
                onRemove: function(map) {
                    // Limpeza se necessário
                }
            });
            var saveButtonControl = new SaveButton();

            // Função para obter a localização do usuário
            function obterLocalizacaoUsuario() {
                clearMapMessage();
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            console.log(`Localização do usuário obtida: ${lat}, ${lon}`);
                            mymap.setView([lat, lon], USER_LOCATION_ZOOM);
                            if (userMarker) mymap.removeLayer(userMarker);
                            userMarker = L.marker([lat, lon], { icon: userIcon }).addTo(mymap)
                                .bindPopup('<b>Você está aqui!</b>')
                                .openPopup();
                            adicionarMarcadoresLojas(lat, lon);
                        },
                        function(error) {
                            console.log("Erro ao obter localização.", error);
                            let errorMessage = "Não foi possível obter sua localização.";
                            if (error.code === error.PERMISSION_DENIED) {
                                errorMessage += " Permissão negada.";
                            }
                            displayMapMessage(errorMessage, 'danger');
                            adicionarMarcadoresLojas();
                        }
                    );
                } else {
                    console.log("Geolocalização não é suportada por este navegador.");
                    displayMapMessage("Seu navegador não suporta geolocalização.", 'warning');
                    adicionarMarcadoresLojas();
                }
            }

            // Função para adicionar marcadores das lojas
            function adicionarMarcadoresLojas(userLat = null, userLon = null) {
                storeMarkers.clearLayers(); // Limpa marcadores antigos
                clearMapMessage();

                let apiUrl = "{% url 'loja:api-listar-lojas' %}";
                if (userLat && userLon) {
                    apiUrl += `?lat=${userLat}&lon=${userLon}`;
                }

                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erro na resposta da rede.');
                        }
                        return response.json();
                    })
                    .then(lojas => {
                        console.log("Lojas recebidas da API:", lojas);
                        if (lojas && lojas.length > 0) {
                            let bounds = [];
                            lojas.forEach(loja => {
                                if (loja.latitude && loja.longitude) {
                                    // Escolhe o ícone baseado no atendimento de emergência
                                    var icon = loja.atendimento_emergencia ? redIcon : blueIcon;

                                    var marker = L.marker([loja.latitude, loja.longitude], { icon: icon });
                                    let popupContent = `<b>${loja.nome}</b><br>${loja.endereco}`;
                                    if (loja.distancia !== null) {
                                        popupContent += `<br><i>Aprox. ${loja.distancia} km de você</i>`;
                                    }
                                    popupContent += `<br><a href="/loja/${loja.id}/">Ver Detalhes</a>`;
                                    marker.bindPopup(popupContent).addTo(storeMarkers);
                                    bounds.push([loja.latitude, loja.longitude]);
                                }
                            });
                            if (bounds.length > 0) {
                                if (!userLat || bounds.length > 1) {
                                    if (bounds.length === 1) {
                                        mymap.setView(bounds[0], SINGLE_STORE_ZOOM);
                                    } else {
                                        mymap.fitBounds(bounds, { padding: FIT_BOUNDS_PADDING });
                                    }
                                }
                            } else {
                                displayMapMessage('Nenhuma loja com localização cadastrada foi encontrada.', 'warning');
                            }
                        } else {
                            displayMapMessage('Nenhuma loja encontrada.', 'info');
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao buscar dados das lojas:', error);
                        displayMapMessage('Erro ao carregar as lojas.', 'danger');
                    });
            }

            // Botão de Localização Personalizado
            var LocateButton = L.Control.extend({
                options: { position: 'topleft' },
                onAdd: function (map) {
                    var container = L.DomUtil.create('div', 'leaflet-control leaflet-control-custom');
                    container.innerHTML = '<button type="button" class="btn btn-light" title="Localizar minha posição"><i class="bi bi-geo-alt-fill"></i></button>';
                    L.DomEvent.disableClickPropagation(container);
                    L.DomEvent.on(container, 'click', function() {
                        obterLocalizacaoUsuario();
                    });
                    return container;
                }
            });
            mymap.addControl(new LocateButton());

            // Lógica de inicialização do mapa
            if (isEditMode && lojaParaEditar) {
                // MODO DE EDIÇÃO
                displayMapMessage(`<strong>Modo de Edição:</strong> Clique ou arraste o marcador para definir a nova localização de <strong>${lojaParaEditar.nome}</strong>.`, 'primary');
                
                let editMarker;
                let newPosition = null;

                // Centraliza na loja se já tiver localização, senão no Brasil
                if (lojaParaEditar.latitude && lojaParaEditar.longitude) {
                    const initialPos = [lojaParaEditar.latitude, lojaParaEditar.longitude];
                    mymap.setView(initialPos, SINGLE_STORE_ZOOM);
                    editMarker = L.marker(initialPos, { draggable: true }).addTo(mymap);
                } else {
                    mymap.setView([-15.7801, -47.9292], DEFAULT_ZOOM);
                }

                // Adiciona o botão de salvar ao mapa
                mymap.addControl(saveButtonControl);
                const saveBtn = document.getElementById('save-location-btn');
                saveBtn.disabled = true; // Desabilitado até uma nova posição ser definida

                // Evento de clique no botão salvar
                L.DomEvent.on(saveBtn, 'click', function() {
                    if (newPosition) {
                        salvarLocalizacao(newPosition.lat, newPosition.lng);
                        saveBtn.disabled = true; // Desabilita após salvar
                    }
                });

                const updateMarkerPosition = (latlng) => {
                    newPosition = latlng;
                    if (!editMarker) {
                        editMarker = L.marker(latlng, { draggable: true }).addTo(mymap);
                        editMarker.on('dragend', (e) => updateMarkerPosition(e.target.getLatLng()));
                    } else {
                        editMarker.setLatLng(latlng);
                    }
                    mymap.panTo(latlng);
                    saveBtn.disabled = false; // Habilita o botão de salvar
                    displayMapMessage(`Nova posição selecionada. Clique em "Salvar Localização".`, 'info');
                };

                mymap.on('click', function(e) {
                    updateMarkerPosition(e.latlng);
                });

                if (editMarker) {
                    editMarker.on('dragend', function(e) {
                        updateMarkerPosition(e.target.getLatLng());
                    });
                }

            } else {
                // MODO DE VISUALIZAÇÃO PADRÃO
                obterLocalizacaoUsuario();
            }

            requestAnimationFrame(function() { // Garante que o mapa renderize corretamente
                mymap.invalidateSize(true);
            });

        });
    </script>
{% endblock %}